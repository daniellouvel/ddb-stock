<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortie Stock - DDB-Stock Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <header class="bg-red-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">üì§ Sortie Stock</h1>
                    <p class="text-red-200 text-sm">Retirer des articles</p>
                </div>
                <a href="home.html" class="bg-white text-red-600 px-3 py-2 rounded-lg text-sm font-medium">
                    ‚Üê Retour
                </a>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Recherche -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 max-w-2xl mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üîç Rechercher un Article</h2>
            
            <div class="flex gap-2">
                <input type="text" id="recherche_code" placeholder="Code article (GGxxxx)" 
                       class="flex-1 px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent uppercase">
                <button onclick="rechercherArticle()" 
                        class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700">
                    üîç Chercher
                </button>
            </div>
            
            <div id="resultat_recherche" class="mt-4 hidden"></div>
        </div>

        <!-- Liste Articles -->
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üì¶ Articles en Stock</h2>
            
            <div id="liste_articles" class="space-y-3">
                <div class="text-center text-gray-500 py-8">Chargement...</div>
            </div>
        </div>

    </div>

    <script>
        const API_URL = 'http://' + window.location.hostname + ':8000';

        // Charger tous les articles
        async function chargerArticles() {
            try {
                const response = await fetch(`${API_URL}/articles/`);
                const articles = await response.json();
                
                const container = document.getElementById('liste_articles');
                
                if (articles.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8">Aucun article en stock</div>';
                    return;
                }
                
                container.innerHTML = articles.map(article => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-mono font-bold">
                                        ${article.code_article}
                                    </span>
                                    <span class="text-lg font-semibold text-gray-800">
                                        ${article.produit.nom}
                                    </span>
                                </div>
                                
                                <div class="text-sm text-gray-600 space-y-1">
                                    ${article.produit.marque ? `<div>üè∑Ô∏è ${article.produit.marque}</div>` : ''}
                                    <div>üìç ${article.emplacement.nom} (${article.emplacement.code_emplacement})</div>
                                    <div>üì¶ Quantit√©: <span class="font-semibold">${article.quantite}</span></div>
                                    ${article.date_peremption ? `
                                        <div class="${isPeremptionProche(article.date_peremption) ? 'text-orange-600 font-semibold' : ''}">
                                            ‚è∞ P√©remption: ${formatDate(article.date_peremption)}
                                        </div>
                                    ` : ''}
                                    ${article.commentaire ? `<div class="text-gray-500">üí¨ ${article.commentaire}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="flex gap-2 ml-4">
                                <button onclick="supprimerArticle(${article.id}, '${article.code_article}', ${article.quantite})" 
                                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm font-medium">
                                    ${article.quantite === 1 ? 'üóëÔ∏è Supprimer' : 'üì§ Retirer'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('liste_articles').innerHTML = 
                    '<div class="text-center text-red-500 py-8">‚ùå Erreur de chargement</div>';
            }
        }

        // Rechercher un article par code
        async function rechercherArticle() {
            const code = document.getElementById('recherche_code').value.trim().toUpperCase();
            if (!code) {
                alert('‚ùå Veuillez saisir un code article');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/articles/code/${code}`);
                const resultatDiv = document.getElementById('resultat_recherche');
                
                if (response.ok) {
                    const article = await response.json();
                    
                    resultatDiv.innerHTML = `
                        <div class="border-2 border-green-500 rounded-lg p-4 bg-green-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="bg-blue-600 text-white px-3 py-1 rounded text-lg font-mono font-bold">
                                            ${article.code_article}
                                        </span>
                                        <span class="text-xl font-bold text-gray-800">
                                            ${article.produit.nom}
                                        </span>
                                    </div>
                                    
                                    <div class="text-sm text-gray-700 space-y-1 mt-3">
                                        ${article.produit.marque ? `<div>üè∑Ô∏è Marque: <span class="font-semibold">${article.produit.marque}</span></div>` : ''}
                                        <div>üìç Emplacement: <span class="font-semibold">${article.emplacement.nom} (${article.emplacement.code_emplacement})</span></div>
                                        <div>üì¶ Quantit√©: <span class="font-bold text-lg">${article.quantite}</span></div>
                                        ${article.date_peremption ? `
                                            <div class="${isPeremptionProche(article.date_peremption) ? 'text-orange-600 font-bold' : ''}">
                                                ‚è∞ P√©remption: ${formatDate(article.date_peremption)}
                                            </div>
                                        ` : ''}
                                        ${article.commentaire ? `<div class="text-gray-600">üí¨ ${article.commentaire}</div>` : ''}
                                    </div>
                                </div>
                                
                                <button onclick="supprimerArticle(${article.id}, '${article.code_article}', ${article.quantite})" 
                                        class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-medium ml-4">
                                    ${article.quantite === 1 ? 'üóëÔ∏è Supprimer' : 'üì§ Retirer'}
                                </button>
                            </div>
                        </div>
                    `;
                    resultatDiv.classList.remove('hidden');
                    
                } else {
                    resultatDiv.innerHTML = `
                        <div class="border-2 border-orange-500 rounded-lg p-4 bg-orange-50 text-orange-800">
                            ‚ùå Article <strong>${code}</strong> non trouv√©
                        </div>
                    `;
                    resultatDiv.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur de connexion');
            }
        }

        // Supprimer ou d√©cr√©menter article
        async function supprimerArticle(articleId, codeArticle, quantiteActuelle) {
            if (quantiteActuelle === 1) {
                // Suppression d√©finitive si quantit√© = 1
                if (!confirm(`‚ö†Ô∏è SUPPRESSION D√âFINITIVE\n\nArticle ${codeArticle}\nQuantit√©: ${quantiteActuelle}\n\nVoulez-vous supprimer d√©finitivement cet article ?\n\nLe code ${codeArticle} sera lib√©r√©.`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/articles/${articleId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(`‚úÖ ${result.message}\n\nCode ${result.code_libere} disponible pour r√©utilisation.`);
                        
                        // Recharger
                        document.getElementById('resultat_recherche').classList.add('hidden');
                        document.getElementById('recherche_code').value = '';
                        chargerArticles();
                    } else {
                        const error = await response.json();
                        alert('‚ùå Erreur: ' + error.detail);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('‚ùå Erreur de connexion');
                }
                
            } else {
                // Proposer de retirer X articles
                const quantite = prompt(`üì¶ Article ${codeArticle}\nQuantit√© en stock: ${quantiteActuelle}\n\nCombien d'articles voulez-vous retirer ?\n\n(Laissez vide ou entrez ${quantiteActuelle} pour tout supprimer)`, '1');
                
                if (quantite === null) return; // Annul√©
                
                const qte = parseInt(quantite) || quantiteActuelle;
                
                if (qte <= 0 || qte > quantiteActuelle) {
                    alert(`‚ùå Quantit√© invalide. Doit √™tre entre 1 et ${quantiteActuelle}`);
                    return;
                }
                
                const action = qte >= quantiteActuelle ? 'SUPPRIMER D√âFINITIVEMENT' : `RETIRER ${qte} article(s)`;
                
                if (!confirm(`Confirmer l'action :\n\n${action}\n\nArticle: ${codeArticle}\nStock actuel: ${quantiteActuelle}`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`${API_URL}/articles/${articleId}?quantite_a_retirer=${qte}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.action === 'suppression_complete') {
                            alert(`‚úÖ ${result.message}\n\nCode ${result.code_libere} disponible pour r√©utilisation.`);
                        } else {
                            alert(`‚úÖ ${result.message}\n\nStock restant: ${result.quantite_restante}`);
                        }
                        
                        // Recharger
                        document.getElementById('resultat_recherche').classList.add('hidden');
                        document.getElementById('recherche_code').value = '';
                        chargerArticles();
                    } else {
                        const error = await response.json();
                        alert('‚ùå Erreur: ' + error.detail);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('‚ùå Erreur de connexion');
                }
            }
        }

        // Formater date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        // V√©rifier si p√©remption proche (moins de 30 jours)
        function isPeremptionProche(dateString) {
            const date = new Date(dateString);
            const maintenant = new Date();
            const diff = date - maintenant;
            const jours = diff / (1000 * 60 * 60 * 24);
            return jours > 0 && jours <= 30;
        }

        // Forcer majuscules
        document.getElementById('recherche_code').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        // Recherche au Enter
        document.getElementById('recherche_code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                rechercherArticle();
            }
        });

        // Charger au d√©marrage
        chargerArticles();
    </script>
</body>
</html>
