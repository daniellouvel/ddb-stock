<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Produits - DDB-Stock</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">üè† DDB-Stock</h1>
                    <p class="text-blue-200">Gestion des Produits</p>
                </div>
                <nav class="space-x-4">
                    <a href="index.html" class="hover:text-blue-200">Dashboard</a>
                    <a href="produits.html" class="text-white font-bold">Produits</a>
                    <a href="emplacements.html" class="hover:text-blue-200">Emplacements</a>
                    <a href="articles.html" class="hover:text-blue-200">Articles</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800" id="formTitle">‚ûï Ajouter un Produit</h2>
                
                <form id="formProduit" class="space-y-4">
                    <input type="hidden" id="produit_id" value="">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Code EAN (optionnel)
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="ean" 
                                   placeholder="Scannez ou saisissez l'EAN"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" onclick="rechercherEAN()" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                üîç
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Recherche automatique des informations produit</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Nom du Produit *
                        </label>
                        <input type="text" id="nom" 
                               placeholder="Ex: Eau min√©rale Evian 1.5L" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Marque
                        </label>
                        <input type="text" id="marque" 
                               placeholder="Ex: Evian"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Description
                        </label>
                        <textarea id="description" 
                                  rows="3" 
                                  placeholder="Description d√©taill√©e du produit..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" 
                                id="btnSubmit"
                                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
                            ‚ûï Ajouter
                        </button>
                        <button type="button" 
                                onclick="annulerModification()"
                                id="btnAnnuler"
                                class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                            Annuler
                        </button>
                    </div>
                </form>

                <div id="message" class="mt-4 hidden"></div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üì¶ Liste des Produits</h2>
                    <button onclick="chargerProduits()" 
                            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition text-sm">
                        üîÑ Rafra√Æchir
                    </button>
                </div>

                <input type="text" 
                       id="searchInput" 
                       placeholder="üîç Rechercher un produit..."
                       onkeyup="filtrerProduits()"
                       class="w-full px-3 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">

                <div class="text-sm text-gray-600 mb-2">
                    <span id="compteur">0</span> produit(s)
                </div>

                <div id="listeProduits" class="space-y-2 max-h-[600px] overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        Chargement...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://' + window.location.hostname + ':8000';
        let produits = [];
        let produitsAffiches = [];
        let modeModification = false;

        window.onload = function() {
            chargerProduits();
        };

        async function chargerProduits() {
            try {
                const response = await fetch(`${API_URL}/produits/`);
                produits = await response.json();
                produitsAffiches = [...produits];
                
                afficherProduits();
                mettreAJourCompteur();
            } catch (error) {
                document.getElementById('listeProduits').innerHTML = 
                    '<div class="text-red-600 text-center py-4">‚ùå Erreur de chargement</div>';
                console.error('Erreur:', error);
            }
        }

        function afficherProduits() {
            const container = document.getElementById('listeProduits');
            
            if (produitsAffiches.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">Aucun produit trouv√©</div>';
                return;
            }

            let html = '';
            produitsAffiches.forEach(produit => {
                html += `
                    <div class="border border-gray-200 rounded-md p-4 hover:bg-gray-50 transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold text-gray-800">${produit.nom}</div>
                                ${produit.marque ? `<div class="text-sm text-gray-600 mt-1">üè∑Ô∏è ${produit.marque}</div>` : ''}
                                ${produit.ean ? `<div class="text-xs text-gray-500 mt-1">EAN: ${produit.ean}</div>` : ''}
                                ${produit.description ? `<div class="text-sm text-gray-600 mt-2">${produit.description}</div>` : ''}
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick='modifierProduit(${JSON.stringify(produit).replace(/'/g, "&#39;")})' 
                                        class="text-blue-600 hover:text-blue-800 px-3 py-1 border border-blue-600 rounded hover:bg-blue-50 transition text-sm">
                                    ‚úèÔ∏è Modifier
                                </button>
                                <button onclick="supprimerProduit(${produit.id}, '${produit.nom.replace(/'/g, "\\'")}' )" 
                                        class="text-red-600 hover:text-red-800 px-3 py-1 border border-red-600 rounded hover:bg-red-50 transition text-sm">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function rechercherEAN() {
            const ean = document.getElementById('ean').value.trim();
            if (!ean) {
                return;
            }

            const btn = event?.target;
            if (btn) {
                btn.textContent = '‚è≥';
                btn.disabled = true;
            }

            try {
                const proxyResponse = await fetch(`${API_URL}/recherche-ean/${ean}`);
                
                if (btn) {
                    btn.textContent = 'üîç';
                    btn.disabled = false;
                }

                if (proxyResponse.ok) {
                    const data = await proxyResponse.json();
                    console.log(`‚úÖ Trouv√© sur ${data.source}`, data);
                    
                    document.getElementById('nom').value = data.nom || '';
                    document.getElementById('marque').value = data.marque || '';
                    document.getElementById('description').value = data.description || '';
                    
                    alert(`‚úÖ Produit trouv√© (${data.source}) :\n\n${data.nom}\nMarque : ${data.marque || 'Inconnue'}`);
                } else {
                    alert(`‚ÑπÔ∏è EAN ${ean} non trouv√©.\n\nVeuillez saisir les informations manuellement.`);
                }
            } catch (error) {
                if (btn) {
                    btn.textContent = 'üîç';
                    btn.disabled = false;
                }
                console.error('Erreur:', error);
                alert('‚ö†Ô∏è Erreur de recherche.');
            }
        }

        document.getElementById('ean').addEventListener('blur', function() {
            if (this.value.trim()) {
                rechercherEAN();
            }
        });

        document.getElementById('formProduit').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('produit_id').value;
            const data = {
                ean: document.getElementById('ean').value || null,
                nom: document.getElementById('nom').value,
                marque: document.getElementById('marque').value || null,
                description: document.getElementById('description').value || null
            };

            try {
                let response;
                if (modeModification && id) {
                    response = await fetch(`${API_URL}/produits/${id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`${API_URL}/produits/`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }

                const messageDiv = document.getElementById('message');

                if (response.ok) {
                    messageDiv.className = 'mt-4 p-3 bg-green-100 text-green-800 rounded-md';
                    messageDiv.textContent = modeModification ? 
                        '‚úÖ Produit modifi√© avec succ√®s' : 
                        '‚úÖ Produit ajout√© avec succ√®s';
                    messageDiv.classList.remove('hidden');
                    
                    annulerModification();
                    chargerProduits();

                    setTimeout(() => messageDiv.classList.add('hidden'), 3000);
                } else {
                    const error = await response.json();
                    messageDiv.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded-md';
                    messageDiv.textContent = '‚ùå Erreur: ' + (error.detail || JSON.stringify(error));
                    messageDiv.classList.remove('hidden');
                }
            } catch (error) {
                const messageDiv = document.getElementById('message');
                messageDiv.className = 'mt-4 p-3 bg-red-100 text-red-800 rounded-md';
                messageDiv.textContent = '‚ùå Erreur de connexion';
                messageDiv.classList.remove('hidden');
                console.error('Erreur:', error);
            }
        });

        function modifierProduit(produit) {
            modeModification = true;
            
            document.getElementById('produit_id').value = produit.id;
            document.getElementById('ean').value = produit.ean || '';
            document.getElementById('nom').value = produit.nom;
            document.getElementById('marque').value = produit.marque || '';
            document.getElementById('description').value = produit.description || '';
            
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Modifier le Produit';
            document.getElementById('btnSubmit').textContent = 'üíæ Enregistrer';
            document.getElementById('btnSubmit').className = 'flex-1 bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 transition';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function annulerModification() {
            modeModification = false;
            
            document.getElementById('formProduit').reset();
            document.getElementById('produit_id').value = '';
            document.getElementById('message').classList.add('hidden');
            
            document.getElementById('formTitle').textContent = '‚ûï Ajouter un Produit';
            document.getElementById('btnSubmit').textContent = '‚ûï Ajouter';
            document.getElementById('btnSubmit').className = 'flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition';
        }

        async function supprimerProduit(id, nom) {
            if (!confirm(`Voulez-vous vraiment supprimer le produit "${nom}" ?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/produits/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('‚úÖ Produit supprim√©');
                    chargerProduits();
                } else {
                    const error = await response.json();
                    alert('‚ùå Erreur: ' + error.detail);
                }
            } catch (error) {
                alert('‚ùå Erreur de connexion');
                console.error(error);
            }
        }

        function filtrerProduits() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            produitsAffiches = produits.filter(produit => {
                return search === '' || 
                    produit.nom.toLowerCase().includes(search) ||
                    (produit.marque && produit.marque.toLowerCase().includes(search)) ||
                    (produit.ean && produit.ean.includes(search)) ||
                    (produit.description && produit.description.toLowerCase().includes(search));
            });
            
            afficherProduits();
            mettreAJourCompteur();
        }

        function mettreAJourCompteur() {
            const total = produits.length;
            const affiches = produitsAffiches.length;
            
            if (total === affiches) {
                document.getElementById('compteur').textContent = total;
            } else {
                document.getElementById('compteur').textContent = `${affiches} / ${total}`;
            }
        }
    </script>
</body>
</html>
